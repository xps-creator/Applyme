services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_PASSWORD: postgres
      POSTGRES_USER: postgres
      POSTGRES_DB: applyme
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./infra/db/init.sql:/docker-entrypoint-initdb.d/init.sql:ro

  api:
    build: ./api
    environment:
      - DATABASE_URL=postgresql+psycopg://postgres:postgres@postgres:5432/applyme
      - APP_JWT_SECRET=replace_with_long_random_32_chars_min
      - INTERNAL_API_KEY=replace_with_internal_secret
      - CORS_ORIGIN=http://localhost:8080
    ports:
      - "8000:8000"
    depends_on:
      - postgres

  web:
    image: nginx:1.27-alpine
    ports:
      - "8080:80"
    volumes:
      - ./web:/usr/share/nginx/html:ro
      - ./web/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - api

  n8n:
    image: n8nio/n8n:1.82.0
    ports:
      - "5678:5678"
    environment:
      - N8N_HOST=localhost
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - N8N_ENCRYPTION_KEY=replace_with_long_random_32_chars_min
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_DATABASE=applyme
      - DB_POSTGRESDB_USER=postgres
      - DB_POSTGRESDB_PASSWORD=postgres
      - DB_POSTGRESDB_PORT=5432
      - WEBHOOK_URL=http://localhost:5678
      - N8N_LOG_LEVEL=info
      # needed by workflow (sent as header to API)
      - INTERNAL_API_KEY=replace_with_internal_secret
    depends_on:
      - postgres

volumes:
  pgdata: